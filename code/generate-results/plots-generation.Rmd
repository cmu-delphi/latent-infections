---
title: "Plots Generation"
author: "Rachel Lobay"
date: "2024-03-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE, 
  message = FALSE, 
  fig.path = here::here("gfx"),
  echo = FALSE,
  dev = "pdf"
)
```


# Plots for Retrospective estimation of latent COVID-19 infections before Omicron in the U.S. paper

This document enables the generation of all non-supplementary plots that appear
in Retrospective estimation of latent COVID-19 infections before Omicron in the
U.S.. We separate these by section and arrange them in order of appearance.

## Load packages and data 

Packages:
```{r load-packages}
library(tidyverse)
library(geofacet)
library(usmap)
library(patchwork)
library(cowplot)
library(here)
# library(viridisLite)
```

Data:
```{r load-data}
adj_df_list <- readRDS(here("data", "adj_df_list_F24.rds"))
adj_df <- bind_rows(adj_df_list)

pop_df <- readRDS(here("data", "pop_df.rds"))
pop_used <- "population_2020"

six_states = c("MT", "MA", "ID", "LA", "CA", "OH")
prop_top_circ_df <- read_rds(here("data", "prop_top_circ_df.rds"))
state_decon_byvar_df <- read_rds(here("data", "state_decon_byvar_df.rds"))

corrs <- read_rds(here("data", "corr_inf_decon_case_lags.rds"))
ihrs_dat <- read_rds(here("data", "ihrs_dat.rds"))
density_data <- read_rds(here("data", "gamma_density_data.rds"))
ca_interp_list <- read_rds(here("data", "ca_interp_list.rds"))

variants <- unique(density_data$variant)
nvar <- length(variants)
# The below makes them as far apart as possible, assuming they are ordered
# generator <- 3 # need a co-prime of nvar near nvar/2
# spaced <- seq(0, by = generator, length = nvar) %% nvar + 1
# variant_colours <- viridisLite::viridis(length(variants))[spaced]
# 
# But for the 6 states, we need Other, Epsilon, Alpha, and Delta to be far
# So we do it manually
variant_colours <- viridisLite::viridis(length(variants))[c(1, 4, 5, 8, 2, 7, 6, 3)]
names(variant_colours) <- variants
```

## Results

Plot specifications:
```{r grid-spec, include = FALSE}
# Create my_grid for facet_geo
my_grid <- us_state_without_DC_grid1
my_grid$row[my_grid$code == "AK"] <- 2
my_grid$row <- my_grid$row - 1
# grid_preview(my_grid)
```

Plots from this section:
```{r adj-unadj-cases-plot, include = FALSE, fig.width = 12, fig.height = 7}
# Adj. infect. and cases / 100k for all states
ggplot(adj_df) +
  geom_ribbon(aes(date, ymin = ninetyfive_lowb_rate, ymax = ninetyfive_upb_rate, fill = "95%")) +
  geom_ribbon(aes(date, ymin = eighty_lowb_rate, ymax = eighty_upb_rate, fill = "80%")) +
  geom_ribbon(aes(date, ymin = fifty_lowb_rate, ymax = fifty_upb_rate, fill = "50%")) +
  geom_line(aes(date, adj_inf_rate, color = "Infections"), size = 0.6) +
  geom_line(aes(date, cases_rate_7d_av, color = "Reported cases"), size = 0.4) +
  scale_x_date(name = "", breaks = seq(as.Date("2020-07-01"), as.Date("2021-07-01"), by = "6 months"),
               date_labels = "%m/%y", expand = c(0,0)) +
  scale_y_continuous(labels = scales::comma, limits = c(0, 600), expand = c(0,0), n.breaks = 4) + 
  scale_color_manual(name='', # Legend
                     breaks=c('Infections',
                              'Reported cases'),
                     values=c('Infections' = "midnightblue",
                              'Reported cases' = "darkorange2")) +
  scale_fill_manual(name = 'Interval', values = c("skyblue3", "lightskyblue", "lightskyblue1")) +
  ylab("Incidence per 100K population") +
  facet_geo(~ geo_value, grid = my_grid) +
  theme_bw(16) +
  theme(axis.text.x = element_text(hjust = 0.1, vjust = 3, size = 5.5),
        axis.text.y = element_text(size = 6.5),
        axis.title.y = element_text(),
        title = element_blank(),
        legend.title = element_text(size = 7.5),
        legend.text = element_text(size = 6.5),
        legend.position = "bottom",
        legend.box.spacing = unit(-1, "pt"),
        panel.spacing = unit(3, "pt"),
        strip.text = element_text(size = 6, face = "bold", margin = margin(1, 0, 1, 0, "mm")))
```


```{r choro-maps, include = FALSE, fig.width=12, fig.height=4}
# Side-by-side choropleth maps for infection and case rates

# Add state name to adj_df 
adj_df = adj_df %>% mutate(state = usdata::abbr2state(geo_value))

total_infects_df = adj_df %>%
  group_by(date) %>%
  summarise(sum_adj_infect = sum(adj_infect)) %>%
  arrange(desc(sum_adj_infect)) %>%
  filter(date <= as.Date("2021-11-01")) 
top_ea_year = total_infects_df %>%
  group_by(year = year(date)) %>% 
  slice(1) # slice 1st value (when arranged from largest to lowest total infections) for each year

# Set dates to plot
first_date = as.Date("2020-06-01")
second_date = as.Date("2020-10-20")
third_date = top_ea_year$date[1]
fourth_date = as.Date("2021-07-20")
fifth_date = top_ea_year$date[2]

# Set max using maximum observed for each of adj_inf_rate and cases_rate_7d_av for the dates considered
max_choro_lim_inf = adj_df %>%
  filter(date %in% c(first_date, second_date, third_date, fourth_date, fifth_date)) %>%
  summarise(max_inf_rate = max(adj_inf_rate)) %>%
  pull(max_inf_rate) 
max_choro_lim_cases = adj_df %>%
  filter(date %in% c(first_date, second_date, third_date, fourth_date, fifth_date)) %>%
  summarise(max_case_rate = max(cases_rate_7d_av)) %>% pull(max_case_rate)


plot_usmap_fun <- function(plot_date, value, plot_name, max_choro_lim){
  plot_usmap(data = adj_df %>% filter(date == plot_date), values = value, color = "black") +
  scale_fill_viridis_c(name = plot_name, label = scales::comma, limits = c(0, max_choro_lim), option = "C") +
  ggtitle(format(plot_date, format = "%b. %d, %Y")) +
  theme(legend.title = element_text(size = 8),
        legend.position="bottom",
        legend.justification="right",
        plot.title = element_text(size = 8, vjust = 0))
}
# Adjusted infection rates plots
p1 <- plot_usmap_fun(first_date, "adj_inf_rate", "Infections", max_choro_lim_inf) 
p2 <- plot_usmap_fun(second_date, "adj_inf_rate", "Infections", max_choro_lim_inf) 
p3 <- plot_usmap_fun(third_date, "adj_inf_rate", "Infections", max_choro_lim_inf) 
p4 <- plot_usmap_fun(fourth_date, "adj_inf_rate", "Infections", max_choro_lim_inf) 
p5 <- plot_usmap_fun(fifth_date, "adj_inf_rate", "Infections", max_choro_lim_inf) 

# 7dav case rate plots
p6 <- plot_usmap_fun(first_date, "cases_rate_7d_av", "Reported cases", max_choro_lim_cases) 
p7 <- plot_usmap_fun(second_date, "cases_rate_7d_av", "Reported cases", max_choro_lim_cases) 
p8 <- plot_usmap_fun(third_date, "cases_rate_7d_av", "Reported cases", max_choro_lim_cases) 
p9 <- plot_usmap_fun(fourth_date, "cases_rate_7d_av", "Reported cases", max_choro_lim_cases) 
p10 <- plot_usmap_fun(fifth_date, "cases_rate_7d_av", "Reported cases", max_choro_lim_cases) 

# Use patchwork to arrange plots side-by-side in ggplot2
p1 + p2 + p3 + p4 + p5 + p6 + p7 + p8 + p9 + p10 + plot_layout(ncol = 5, guides = "collect") & theme(legend.position = 'right', legend.justification = 'right')
```


```{r six-cases-decon-infect, include = FALSE}
# Reported cases and estimates of daily new infections (dark blue line) per 100K inhabitants for a sample of six states

six_plt1 <- ggplot(adj_df %>% filter(geo_value %in% six_states)) +
  geom_ribbon(aes(date, ymin = ninetyfive_lowb_rate, ymax = ninetyfive_upb_rate, fill = "95%")) +
  geom_ribbon(aes(date, ymin = eighty_lowb_rate, ymax = eighty_upb_rate, fill = "80%")) +
  geom_ribbon(aes(date, ymin = fifty_lowb_rate, ymax = fifty_upb_rate, fill = "50%")) +
  geom_line(aes(date, adj_inf_rate, color = "Infections"), size = 0.6) +
  geom_line(aes(date, cases_rate_7d_av, color = "Reported cases"), size = 0.4) +
  scale_x_date(name = "", breaks = seq(as.Date("2020-07-01"), as.Date("2021-07-01"), by = "6 months"),
               date_labels = "%b %Y", expand = c(0, 0)) +
  #scale_x_date(name = "", date_breaks = "4 month", expand = c(0,0)) +
  scale_y_continuous(labels = scales::comma, limits = c(0, 650), expand = c(0,0)) + 
  scale_color_manual(
    name='', # Legend
    breaks=c('Infections', 'Reported cases'),
    values=c('Infections' = "midnightblue",
             'Reported cases' = "darkorange2")
  ) +
  scale_fill_manual(
    name = 'Interval', 
    values = c("50%" = "skyblue3", "80%" = "lightskyblue", "95%" = "lightskyblue1"),
    guide = guide_legend(direction = "vertical", ncol = 3)
  ) +
  ylab("") +
  facet_wrap(. ~ geo_value, ncol = 3) +
  theme_bw(16) +
  theme(axis.text.x = element_blank(),# element_text(angle = 60, hjust = 1, size = 8.5),
        #axis.text.y = element_text(size = 8.5),
        axis.title.y=element_blank(),
        title = element_blank(),
        legend.title = element_text(),
        legend.title.position = "top",
        #legend.text = element_text(size = 8.5),
        legend.position = "bottom", 
        legend.box.spacing = unit(5, "pt"),
        strip.text = element_text(size = 8, face = "bold", margin = margin(1, 0, 1, 0, "mm")))
```


```{r six-decon-var, include = FALSE, fig.width=10, fig.height=8}
# Deconvolved cases colored by variant per 100K inhabitants

six_plt2 <- ggplot(state_decon_byvar_df, aes(time_value, infect_rate, fill = variant)) +
  geom_area(position = "stack") + 
  scale_x_date(name = "", breaks = seq(as.Date("2020-07-01"), as.Date("2021-07-01"), by = "6 months"),
               date_labels = "%b %Y", expand = c(0, 0)) +
  #scale_x_date(name = "", date_breaks = "4 month", date_labels = "%b %Y", expand = c(0,0)) + 
  scale_y_continuous(limits = c(0, 115), expand = c(0,0.05), breaks = c(0, 50, 100)) + 
  facet_wrap(. ~ geo_value, ncol = 3) +
  theme_bw(16) +
  theme(axis.text.x = element_text(size = 8.5),
        #axis.text.y = element_text(size = 8.5),
        axis.title.y=element_blank(),
        #title = element_blank(),
        legend.title = element_text(),
        legend.title.position = "top",
        #legend.text = element_text(size = 8.5),
        legend.position = "right", 
        legend.box.spacing = unit(5, "pt"),
        strip.text = element_text(size = 8, face = "bold", margin = margin(1, 0, 1, 0, "mm"))) +
  #guides(fill = guide_legend(nrow = 1)) +
  xlab("") + 
  ylab("Deconvolved cases / 100k") + 
  scale_fill_manual(
    name = "Variant", values = variant_colours,
    guide = guide_legend(nrow = 1)
  ) +
theme(legend.position = "bottom")

shared_y_lab <- ggdraw() +
  draw_label("Incidence per 100K population", x = 0, angle = 90) +
  theme(plot.margin = margin(l = 15))

pg <- plot_grid(six_plt1, six_plt2, nrow = 2, align = "v", labels = "AUTO")
plot_grid(shared_y_lab, pg, nrow = 1, rel_widths = c(.05, 1))
```





```{r corr-plot, include = FALSE, fig.width=8, fig.height=5}
# Infection and case average correlation across lags on the same plot
corrs_df <- list_rbind(corrs[1:2], names_to = "type") |> 
  mutate(type = case_when(
    type == "infect_res" ~ "Infections",
    type == "cases_res" ~ "Reported cases"
  ))
ggplot(corrs_df, aes(lag, cor, color = type, group = type)) +
  geom_line() + 
  geom_point() +
  geom_vline(
    data = filter(corrs_df, cor == max(cor), .by = type),
    aes(xintercept = lag, color = type), linetype = 2) +
  scale_color_manual(
    name = "", 
    values = c("Infections" = "midnightblue", 
               "Reported cases" = "darkorange2"
    )) +
  labs(x = "Days before from hospitalization", y = "Average correlation") +
  theme_bw(16) +
  theme(legend.position = "inside",
        legend.position.inside = c(.85, .90),
        axis.text.x = element_text(size = 12),
        axis.title.x = element_text(size = 14),
        axis.text.y = element_text(size = 12),
        axis.title.y = element_text(size = 14),
        legend.text = element_text(size = 12),
        legend.background=element_blank(),
        legend.key = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```

```{r ihrs, include = FALSE, fig.width=12, fig.height=7}
# Rolling window time-varying IHRs for each state 

ggplot(ihrs_dat, aes(x = time_value)) +
  geom_line(aes(y = IHR, color = "Infections")) +
  geom_line(aes(y = CHR, color = "Cases")) +
  facet_geo( ~ geo_value, grid = my_grid) +
  ylab("Hospitalization to incidence ratio") +
  scale_x_date(name = "", breaks = seq(as.Date("2020-07-01"), as.Date("2021-07-01"), by = "6 months"),
               date_labels = "%m/%y", expand = c(0,0)) +
  coord_cartesian(ylim = c(0, 0.3)) +  
  theme_bw(16) +
  theme(axis.text.x = element_text(hjust = 0.1, vjust = 2.5, size = 6.4),
        axis.text.y = element_text(size = 6.4),
        axis.title.x=element_blank(),
        legend.title = element_text(size = 7.5),
        legend.text = element_text(size = 6.4),
        legend.position = c(0.9, 0.15),
        panel.spacing = unit(3, "pt"),
        strip.text = element_text(size = 8, face = "bold", margin = margin(1, 0, 1, 0, "mm"))) +
  scale_color_manual(
    name = "",
    values=c('Infections' = "midnightblue",'Cases' = "darkorange2")
    )
```


## Methods

```{r inc-gammas, include = FALSE, fig.width=6, fig.height=4}
# Plot densities faceted by variant

ggplot(density_data, aes(x = x, y = density, color = variant)) +
  geom_line() +
  scale_x_continuous(expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 0.35)) + 
  theme_bw() +
  labs(x = "Days from infection to symptoms",
       y = "Density") +
  scale_colour_manual(name = "Variant", values = variant_colours)
```

```{r var-props, include = FALSE, fig.width=8, fig.height=4}
# Original biweekly proportions of the variants in circulation for California.
# And daily proportions of the variants in circulation for California.

gisaid <- tibble(ca_interp_list$y_props, Date = ca_interp_list$date)
smoothed <- tibble(
  as_tibble(ca_interp_list$pred2), 
  Date = seq(min(ca_interp_list$date), max(ca_interp_list$date), by = "1 day")
)
comb_var_prop <- list_rbind(list(
  `Reported biweekly proportions` = gisaid,
  `Smoothed daily proportion estimates` = smoothed),
  names_to = "version"
) |> mutate(version = factor(
  version, 
  levels = c("Reported biweekly proportions", "Smoothed daily proportion estimates")
))

comb_var_prop |>
  pivot_longer(Alpha:Other) |>
  ggplot(aes(Date, y = value, fill = name)) +
  geom_area(position = "stack") +
  theme_bw() +
  ylab("Variants in circulation, California") +
  xlab("") + 
  theme_bw() +
  facet_wrap(~version) +
  scale_x_date(name = "", date_breaks = "1 year", date_labels = "%Y", expand = c(0,0)) +
  scale_y_continuous(expand = c(0,0)) + 
  scale_fill_manual(name = "", values = variant_colours)
```

